#!/bin/bash

DIR="$(dirname "$0")"
PARENT=$(dirname "$DIR")

if [[ $1 == "tokenize" ]]; then
    python3 "$DIR/_tokenize.py" ${@:2}
elif [[ $1 == "predict" ]]; then
    shift  # Remove 'predict' from arguments

    if [[ $# -eq 0 ]]; then
        echo "Usage: rn-coverage predict <input.h5> [-o output_dir]"
        echo "       rn-coverage predict --config <config.yaml>"
        exit 1
    fi

    # Check if using config file mode
    if [[ $1 == "--config" ]]; then
        if [[ $# -ne 2 ]]; then
            echo "Usage: rn-coverage predict --config <config.yaml>"
            exit 1
        fi
        TMP=$(mktemp)
        envsubst < $PARENT/config/inference.yaml > $TMP
        PYTHONPATH="$PARENT" python3 -m src predict --config $TMP --config $2
    else
        # Simple mode: predict <input.h5> [-o output_dir]
        INPUT_FILE=$1
        OUTPUT_DIR="predictions"

        # Parse optional -o flag
        if [[ $2 == "-o" ]]; then
            if [[ -z $3 ]]; then
                echo "Error: -o requires an output directory"
                exit 1
            fi
            OUTPUT_DIR=$3
        fi

        # Validate input file exists
        if [[ ! -f $INPUT_FILE ]]; then
            echo "Error: Input file '$INPUT_FILE' does not exist"
            exit 1
        fi

        # Create temporary config with input/output paths
        TMP_BASE=$(mktemp)
        TMP_USER=$(mktemp)

        envsubst < $PARENT/config/inference.yaml > $TMP_BASE

        cat > $TMP_USER << EOF
trainer:
  callbacks:
    - class_path: src.data.writing.HDF5PredictionWriter
      init_args:
        path: $OUTPUT_DIR
        variable_name: reads
        write_interval: batch

data:
  init_args:
    batch_size: 1
    paths:
      predict:
        - $INPUT_FILE
EOF

        PYTHONPATH="$PARENT" python3 -m src predict --config $TMP_BASE --config $TMP_USER

        rm -f $TMP_BASE $TMP_USER
    fi
elif [[ $1 == "train" ]]; then
    if [[ $# -ne 2 ]]; then
        echo "Usage: rn-coverage train CONFIG"
        exit 1
    fi
    TMP=$(mktemp)
    envsubst < $PARENT/config/training.yaml > $TMP
    PYTHONPATH="$PARENT" python3 -m src fit --config $TMP --config $2
elif [[ $1 == "finetune" ]]; then
    if [[ $# -ne 2 ]]; then
        echo "Usage: rn-coverage finetune CONFIG"
        exit 1
    fi
    TMP=$(mktemp)
    envsubst < $PARENT/config/finetuning.yaml > $TMP
    PYTHONPATH="$PARENT" python3 -m src fit --config $TMP --config $2
elif [[ $1 == "extract" ]]; then
    PYTHONPATH="$PARENT" python3 "$DIR/_extract.py" ${@:2}
else
    echo "Usage: rn-coverage tokenize|train|finetune|predict|extract"
    exit 1
fi
